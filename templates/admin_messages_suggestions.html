{% extends "base.html" %}
{% block title %}Messages & Suggestions - Admin{% endblock %}
{% block content %}

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="admin-page-title">Messages & Suggestions</h1>
        <div>
            <a href="{{ url_for('admin_wishlist') }}" class="btn btn-wishlist-link">‚ú® View Wishlist</a>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-back">‚Üê Back to Dashboard</a>
        </div>
    </div>

    <!-- SUGGESTIONS SECTION -->
    <div class="about-section mb-5">
        <h2 class="section-main-title">üí° Suggestions ({{ unread_suggestions }} Unread)</h2>
        
        {% if suggestions %}
        <div class="table-responsive">
            <table class="table table-striped table-dark admin-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for suggestion in suggestions %}
                    {% if not suggestion.archived and not suggestion.added_to_wishlist %}
                    <tr>
                        <td>{{ suggestion.submitted_at.strftime('%m-%d-%Y') }}</td>
                        <td><strong>{{ suggestion.name }}</strong></td>
                        <td>
                            {% if suggestion.email %}
                            <a href="mailto:{{ suggestion.email }}" class="email-link">
                                {{ suggestion.email }}
                            </a>
                            {% else %}
                            <span style="color: rgba(255, 255, 255, 0.5);">No email</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge badge-status-{{ suggestion.status if suggestion.status else 'unread' }}">
                                {{ suggestion.status if suggestion.status else 'unread' }}
                            </span>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-actions dropdown-toggle" type="button" id="dropdownSuggestion{{ suggestion.suggestion_id }}" data-bs-toggle="dropdown">
                                    Actions
                                </button>
                                <ul class="dropdown-menu dropdown-menu-dark">
                                    <li>
                                        <a class="dropdown-item" href="#" onclick="openSuggestionModal('{{ suggestion.name|replace("'", "\\'") }}', '{{ suggestion.suggestion|replace("'", "\\'")|replace("\n", "\\n") }}', '{{ suggestion.suggestion_type|replace("'", "\\'") }}', '{{ suggestion.submitted_at.strftime('%m-%d-%Y') }}'); return false;">
                                            üëÅÔ∏è View Suggestion
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form method="POST" action="{{ url_for('add_suggestion_to_wishlist_route', suggestion_id=suggestion.suggestion_id) }}" style="margin: 0;">
                                            <button type="submit" class="dropdown-item">‚ú® Add to Wishlist</button>
                                        </form>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    {% if suggestion.status != 'read' %}
                                    <li>
                                        <form method="POST" action="{{ url_for('update_suggestion_status', suggestion_id=suggestion.suggestion_id) }}" style="margin: 0;">
                                            <input type="hidden" name="status" value="read">
                                            <button type="submit" class="dropdown-item">‚úì Mark as Read</button>
                                        </form>
                                    </li>
                                    {% endif %}
                                    {% if suggestion.status != 'unread' %}
                                    <li>
                                        <form method="POST" action="{{ url_for('update_suggestion_status', suggestion_id=suggestion.suggestion_id) }}" style="margin: 0;">
                                            <input type="hidden" name="status" value="unread">
                                            <button type="submit" class="dropdown-item">‚óã Mark as Unread</button>
                                        </form>
                                    </li>
                                    {% endif %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form method="POST" action="{{ url_for('archive_suggestion', suggestion_id=suggestion.suggestion_id) }}" style="margin: 0;" onsubmit="return confirm('Archive this suggestion?');">
                                            <button type="submit" class="dropdown-item text-warning">üì¶ Archive</button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No suggestions yet.</p>
        {% endif %}
    </div>

    <!-- MESSAGES/CONTACTS SECTION -->
    <div class="about-section">
        <h2 class="section-main-title">üìß Contact Messages ({{ unread_contacts }} Unread)</h2>
        
        {% if contacts %}
        <div class="table-responsive">
            <table class="table table-striped table-dark admin-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Actions</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contact in contacts %}
                    <tr>
                        <td>{{ contact.submitted_at.strftime('%m-%d-%Y') }}</td>
                        <td><strong>{{ contact.name }}</strong></td>
                        <td>
                            <a href="mailto:{{ contact.email }}" class="email-link">
                                {{ contact.email }}
                            </a>
                        </td>
                        <td>
                            <span class="badge badge-status-{{ contact.status }}">
                                {{ contact.status }}
                            </span>
                        </td>
                        <td>
                            {% if contact.status == 'unread' %}
                            <form method="POST" action="{{ url_for('update_contact_submission_status', submission_id=contact.submission_id, status='read') }}" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-action">Mark as Read</button>
                            </form>
                            {% else %}
                            <form method="POST" action="{{ url_for('update_contact_submission_status', submission_id=contact.submission_id, status='unread') }}" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-action">Mark as Unread</button>
                            </form>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-view-submission" onclick="openContactModal({{ loop.index0 }})">
                                View Message
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No contact messages yet.</p>
        {% endif %}
    </div>
</div>

<!-- SUGGESTION MODAL -->
<div id="suggestionModal" class="suggestion-modal" onclick="closeSuggestionModal(event)">
    <div class="suggestion-modal-content" onclick="event.stopPropagation()">
        <span class="suggestion-modal-close" onclick="closeSuggestionModal()">&times;</span>
        <div class="suggestion-modal-header">
            <h3 id="modalSuggestionName"></h3>
        </div>
        <div class="suggestion-modal-meta">
            <span id="modalSuggestionType" class="badge"></span>
            <p class="suggestion-modal-date" id="modalSuggestionDate"></p>
        </div>
        <div class="suggestion-modal-body">
            <h5>Suggestion:</h5>
            <p id="modalSuggestionText"></p>
        </div>
    </div>
</div>

<!-- CONTACT MESSAGE MODAL -->
<div id="contactModal" class="submission-modal" onclick="closeContactModal(event)">
    <div class="submission-modal-content" onclick="event.stopPropagation()">
        <div class="submission-modal-header">
            <h2 id="contactName">üí¨ Message</h2>
            <button class="submission-modal-close" onclick="closeContactModal(event)">&times;</button>
        </div>
        <div class="submission-modal-body">
            <div class="submission-message" id="contactMessage"></div>
        </div>
        <div class="submission-modal-footer">
            <button class="btn btn-submission-close" onclick="closeContactModal(event)">Close</button>
        </div>
    </div>
</div>

<style>
.section-main-title {
    color: #E0B0FF;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #9874D3;
}
</style>

<script>
const contacts = {{ contacts | tojson }};

function openSuggestionModal(name, suggestion, type, date) {
    document.getElementById('modalSuggestionName').textContent = name;
    document.getElementById('modalSuggestionType').textContent = type;
    document.getElementById('modalSuggestionDate').textContent = 'Submitted: ' + date;
    document.getElementById('modalSuggestionText').textContent = suggestion;
    const badge = document.getElementById('modalSuggestionType');
    badge.className = 'badge badge-suggestion-type-' + type.toLowerCase().replace(/\//g, '-').replace(/ /g, '-');
    document.getElementById('suggestionModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeSuggestionModal(event) {
    if (!event || event.target.id === 'suggestionModal' || event.target.className === 'suggestion-modal-close') {
        document.getElementById('suggestionModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

function openContactModal(index) {
    const contact = contacts[index];
    document.getElementById('contactMessage').textContent = contact.message;
    document.getElementById('contactModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeContactModal(event) {
    event.stopPropagation();
    document.getElementById('contactModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeSuggestionModal();
        closeContactModal(event);
    }
});
</script>

{% endblock %}
